<div
  id="cursor"
  class="pointer-events-none fixed top-0 left-0 z-[9999] hidden -translate-x-1/2 -translate-y-1/2 items-center justify-center mix-blend-difference md:flex"
>
  <div id="cursor-visual" class="h-5 w-5 rounded-full bg-white transition-transform duration-300">
  </div>
</div>

<script>
  import gsap from 'gsap';

  const cursor = document.getElementById('cursor');
  const cursorVisual = document.getElementById('cursor-visual');
  let isHovering = false;
  let isCrabMode = false;

  // Mouse state
  const mouse = { x: 0, y: 0 };
  const pos = { x: 0, y: 0 };
  const speed = 0.15; // Lower = smoother/more "weighty", Higher = snappier. 0.15 is a sweet spot.

  // Setup GSAP quickSetter for performance
  const setX = gsap.quickSetter(cursor, 'x', 'px');
  const setY = gsap.quickSetter(cursor, 'y', 'px');

  // Update mouse position
  window.addEventListener('mousemove', (e) => {
    mouse.x = e.clientX;
    mouse.y = e.clientY;
  });

  // Animation Loop - The "Sleekness" Engine
  gsap.ticker.add(() => {
    // Frame-rate independent smoothing
    const dt = 1.0 - Math.pow(1.0 - speed, gsap.ticker.deltaRatio());

    pos.x += (mouse.x - pos.x) * dt;
    pos.y += (mouse.y - pos.y) * dt;

    setX(pos.x);
    setY(pos.y);
  });

  // State Management
  const updateCursor = () => {
    if (!cursorVisual) return;

    if (isCrabMode) {
      // Crab Mode
      if (cursor) cursor.style.mixBlendMode = 'normal'; // Show emoji colors
      cursorVisual.innerText = 'ðŸ¦€';

      gsap.to(cursorVisual, {
        scale: 2.5,
        backgroundColor: 'transparent',
        duration: 0.4,
        ease: 'back.out(1.7)', // Bouncy pop for the crab
        overwrite: true, // Ensure we kill conflicting tweens
      });
      cursorVisual.style.fontSize = '16px';
    } else if (isHovering) {
      // Hover Mode
      if (cursor) cursor.style.mixBlendMode = 'difference';
      cursorVisual.innerText = '';

      gsap.to(cursorVisual, {
        scale: 3,
        backgroundColor: 'white',
        duration: 0.1, // Snappier zoom
        ease: 'expo.out',
        overwrite: true,
      });
    } else {
      // Default Mode
      if (cursor) cursor.style.mixBlendMode = 'difference';
      cursorVisual.innerText = '';

      gsap.to(cursorVisual, {
        scale: 1,
        backgroundColor: 'white',
        duration: 0.1, // Snappier return
        ease: 'expo.out',
        overwrite: true,
      });
    }
  };

  // Click Feedback - Snappy & Satisfying
  window.addEventListener('mousedown', () => {
    if (!isCrabMode && cursorVisual) {
      gsap.to(cursorVisual, {
        scale: isHovering ? 2.5 : 0.8,
        duration: 0.15,
        ease: 'power3.out',
        overwrite: 'auto',
      });
    }
  });

  window.addEventListener('mouseup', () => {
    if (!isCrabMode && cursorVisual) {
      gsap.to(cursorVisual, {
        scale: isHovering ? 3 : 1,
        duration: 0.3,
        ease: 'back.out(1.2)', // Subtle bounce back
        overwrite: 'auto',
      });
    }
  });

  // Element Tracking
  const initListeners = () => {
    const hoverables = document.querySelectorAll('a, button, .magnetic, [data-cursor="hover"]');
    const crabTriggers = document.querySelectorAll('.crab-trigger');

    hoverables.forEach((el) => {
      el.addEventListener('mouseenter', () => {
        isHovering = true;
        updateCursor();
      });
      el.addEventListener('mouseleave', () => {
        isHovering = false;
        updateCursor();
      });
    });

    crabTriggers.forEach((el) => {
      el.addEventListener('mouseenter', () => {
        isCrabMode = true;
        updateCursor();
      });
      el.addEventListener('mouseleave', () => {
        isCrabMode = false;
        updateCursor();
      });
    });
  };

  // Init
  initListeners();
</script>
